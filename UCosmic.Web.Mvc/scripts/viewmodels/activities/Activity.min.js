var ViewModels;(function(n){(function(n){var t=function(){function n(n){this.locations=ko.observableArray(),this.selectedLocations=ko.observableArray(),this.institutions=ko.observableArray(),this.activityTypes=ko.observableArray(),this.addingTag=ko.observable(!1),this.newTag=ko.observable(),this.uploadingDocument=ko.observable(!1),this.inititializationErrors="",this._initialize(n)}return n.prototype._initialize=function(n){this.id=ko.observable(n)},n.prototype.setupWidgets=function(n,t,i,r,u){var f=this;return $("#"+n).kendoDatePicker(),$("#"+t).kendoDatePicker(),$("#"+i).kendoMultiSelect({dataTextField:"officialName()",dataValueField:"id()",dataSource:this.locations(),change:function(n){this.updateLocations(n.sender.value())},placeholder:"[Select Country/Location, Body of Water or Global]"}),tinyMCE.init({content_css:"../../scripts/tinymce/css/content.css",convert_urls:!1,theme:"advanced",mode:"exact",elements:"tinymce",height:"300",width:"100%",verify_html:!0,plugins:"save,autosave,paste,searchreplace,table,nonbreaking",theme_advanced_buttons1:"save,undo,redo,restoredraft,|,formatselect,bold,italic,underline,|,link,unlink,|,bullist,numlist,|,outdent,indent,blockquote,|,sub,sup,charmap,code",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,image,hr,nonbreaking,tablecontrols",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:!0,theme_advanced_resizing_max_height:"580",theme_advanced_resize_horizontal:!1,theme_advanced_blockformats:"h2,h3,p,blockquote",save_enablewhendirty:!0,save_onsavecallback:"onSavePluginCallback",template_external_list_url:"lists/template_list.js",external_link_list_url:"lists/link_list.js",external_image_list_url:"lists/image_list.js",media_external_list_url:"lists/media_list.js"}),$("#"+r).kendoUpload({multiple:!1,showFileList:!1,async:{saveUrl:App.Routes.WebApi.Activities.Documents.post(this.id()),autoUpload:!0},select:function(n){for(var t=0,i=!0,r;t<n.files.length&&i;)r=n.files[t],i=f.validateUploadableFileTypeByExtension(f.id(),r.extension),i||n.preventDefault(),t+=1},success:function(){f.uploadingDocument(!1),f.loadDocuments()}}),$("#"+u).kendoAutoComplete({dataTextField:"officialName()",dataValueField:"id()",dataSource:this.institutions(),placeholder:"[Enter tag]"}),!0},n.prototype.setupValidation=function(){return this.values.title.extend({required:!0}),ko.validation.group(this),!0},n.prototype.load=function(){var n=this,u=$.Deferred(),f=jQuery.Deferred(),t,i,r;return jQuery.get(App.Routes.WebApi.Activities.Locations.get()).done(function(n){f.resolve(n)}).fail(function(n,t,i){f.reject(n,t,i)}),t=jQuery.Deferred(),jQuery.get(App.Routes.WebApi.Activities.Institutions.get()).done(function(n){t.resolve(n)}).fail(function(n,i,r){t.reject(n,i,r)}),i=jQuery.Deferred(),jQuery.get(App.Routes.WebApi.Employees.ModuleSettings.ActivityTypes.get()).done(function(n){i.resolve(n)}).fail(function(n,t,r){i.reject(n,t,r)}),r=jQuery.Deferred(),jQuery.ajax({type:"GET",url:App.Routes.WebApi.Activities.get(this.id()),success:function(n){r.resolve(n)},error:function(n,t,i){r.reject(n,t,i)}}),jQuery.when(t,i,f,r).done(function(t,i,r,f){var o,s,e;for(n.activityTypes=ko.mapping.fromJS(i),n.locations=ko.mapping.fromJS(r),n.institutions=ko.mapping.fromJS(t),o=function(n){ko.mapping.fromJS(n,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Documents.Thumbnail.get(this.id(),n.id))},s={documents:{create:function(n){return new o(n.data)}},startsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}},endsOn:{create:function(n){return n.data!=null?ko.observable(moment(n.data).toDate()):ko.observable()}}},ko.mapping.fromJS(f,s,n),e=0;e<n.values.locations().length;e+=1)n.selectedLocations.push(n.values.locations()[e].placeId());for(e=0;e<n.activityTypes().length;e+=1)n.activityTypes()[e].checked=ko.computed(n.defHasActivityTypeCallback(e));u.resolve()}).fail(function(n,t,i){u.reject(n,t,i)}),u},n.prototype.save=function(){return this.isValid(),!0},n.prototype.cancel=function(){return!0},n.prototype.addActivityType=function(n){var i=this.getActivityTypeIndexById(n),t;i==-1&&(t=ko.mapping.fromJS({id:0,typeId:n}),this.values.types.push(t))},n.prototype.removeActivityType=function(n){var t=this.getActivityTypeIndexById(n),i;t!=-1&&(i=this.values.types()[t],this.values.types.remove(i))},n.prototype.getTypeName=function(n){var t="",i=this.getActivityTypeIndexById(n);return i!=-1&&(t=this.activityTypes[i].type),t},n.prototype.getActivityTypeIndexById=function(n){var i=-1,t;if(this.values.types!=null&&this.values.types().length>0){for(t=0;t<this.values.types().length&&n!=this.values.types()[t].typeId();)t+=1;t<this.values.types().length&&(i=t)}return i},n.prototype.hasActivityType=function(n){return this.getActivityTypeIndexById(n)!=-1},n.prototype.defHasActivityTypeCallback=function(n){var t=this;return{read:function(){return t.hasActivityType(t.activityTypes()[n].id())},write:function(t){t?this.addActivityType(this.activityTypes()[n].id()):this.removeActivityType(this.activityTypes()[n].id())},owner:this}},n.prototype.updateLocations=function(n){var t,i;for(this.values.locations=ko.observableArray(),t=0;t<n.length;t+=1)i=ko.mapping.fromJS({id:0,placeId:n[t]}),this.values.locations.push(i)},n.prototype.addTag=function(){var n=this.newTag(),t,i;n=n!=null?n.trim():null,n==null||n.length==0||this.haveTag(n)||(t={id:0,number:0,text:n,domainTypeText:null,domainKey:null,modeText:this.modeText(),isInstitution:!1},i=ko.mapping.fromJS(t),this.values.tags.push(i)),this.newTag(null)},n.prototype.removeTag=function(n){this.values.tags.remove(n)},n.prototype.haveTag=function(n){return this.tagIndex(n)!=-1},n.prototype.tagIndex=function(n){for(var t=0;t<this.values.tags().length&&n!=this.values.tags()[t].text();)t+=1;return this.values.tags().length>0&&t<this.values.tags().length?t:-1},n.prototype.validateUploadableFileTypeByExtension=function(n,t){var r=!0,i=t;return i==null||i.length==0||i.length>255?r=!1:(i[0]==="."&&(i=i.substring(1)),jQuery.ajax({async:!1,type:"POST",url:App.Routes.WebApi.Activities.Documents.validateFileExtensions(n),data:ko.toJSON(i),dataType:"json",contentType:"application/json",success:function(){r=!0},error:function(){r=!1}})),r},n.prototype.loadDocuments=function(){var n=this;jQuery.ajax({type:"GET",url:App.Routes.WebApi.Activities.Documents.get(this.id(),null,this.modeText()),dataType:"json",success:function(t){var u=function(n){ko.mapping.fromJS(n,{},this),this.proxyImageSource=ko.observable(App.Routes.WebApi.Activities.Document.Thumbnail.get(this.id(),n.id))},f={create:function(n){return new u(n.data)}},r=ko.mapping.fromJS(t,f),i;for(n.values.documents.removeAll(),i=0;i<r().length;i+=1)n.values.documents.push(r()[i])},error:function(n,t,i){alert("Unable to update documents list. "+t+"|"+i)}})},n.prototype.deleteDocument=function(n){var t=this;jQuery.ajax({type:"DELETE",url:App.Routes.WebApi.Activities.Documents.del(this.id(),n.id()),dataType:"json",success:function(){t.loadDocuments()},error:function(n,t,i){alert("Unable to delete document. "+t+"|"+i)}})},n}();n.Activity=t})(n.Activities||(n.Activities={}));var t=n.Activities})(ViewModels||(ViewModels={}))