define(["require","exports","./SearchResult","./Search","./Name","./Location","./Url","../Widgets/Spinner","languages/ServerApiModel"],function(n,t,i,r,u,f,e,o,s){var g=google.maps,p=i,w=r,c=u,b=f,l=e,h=o,k=s,d=function(){function n(){this.async=!0,this.message="error",this._isAwaitingResponse=!1,this._ruleName="validEstablishmentCeebCode",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;this._isValidatable(t)?(r=App.Routes.WebApi.Establishments.validateCeebCode(t.id),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):(!this._isAwaitingResponse||this._isOk(t))&&i(!0)},n.prototype._isValidatable=function(n){var t=n.originalValues();return n.id&&n.id!==0?!this._isAwaitingResponse&&n&&n.ceebCode()&&t&&t.ceebCode!==n.ceebCode():n&&n.ceebCode()&&!this._isAwaitingResponse},n.prototype._isOk=function(n){var t=n.originalValues();return n.id&&n.id!==0?n&&n.ceebCode()!==undefined&&t&&t.ceebCode==n.ceebCode():!1},n}(),a,v,y;new d,a=function(){function n(){this.async=!0,this.message="error",this._isAwaitingResponse=!1,this._ruleName="validEstablishmentUCosmicCode",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;this._isValidatable(t)?(r=App.Routes.WebApi.Establishments.validateUCosmicCode(t.id),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):(!this._isAwaitingResponse||this._isOk(t))&&i(!0)},n.prototype._isValidatable=function(n){var t=n.originalValues();return n.id&&n.id!==0?!this._isAwaitingResponse&&n&&n.uCosmicCode()&&t&&t.uCosmicCode!==n.uCosmicCode():n&&n.uCosmicCode()&&!this._isAwaitingResponse},n.prototype._isOk=function(n){var t=n.originalValues();return n.id&&n.id!==0?n&&n.uCosmicCode()!==undefined&&t&&t.uCosmicCode==n.uCosmicCode():!1},n}(),new a,v=function(){function n(){this.async=!0,this.message="error",this._isAwaitingResponse=!1,this._ruleName="validEstablishmentParentId",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;this._isValidatable(t)?(r=App.Routes.WebApi.Establishments.validateParentId(t.id),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):(!this._isAwaitingResponse||this._isOk(t))&&i(!0)},n.prototype._isValidatable=function(n){var t=n.originalValues();return n.id&&n.id!==0?!this._isAwaitingResponse&&n&&n.parentId()&&t&&t.parentId!==n.parentId():!1},n.prototype._isOk=function(n){var t=n.originalValues();return n.id&&n.id!==0?n&&n.parentId()&&t&&t.parentId==n.parentId():!0},n}(),new v,y=function(){function n(n){var t=this,i,r;this.id=0,this.originalValues=ko.observable(),this._isInitialized=ko.observable(!1),this.$genericAlertDialog=undefined,this.createSpinner=new h.Spinner(new h.SpinnerOptions(0)),this.validatingSpinner=new h.Spinner(new h.SpinnerOptions(200)),this.categories=ko.observableArray(),this.typeIdSaveSpinner=new h.Spinner(new h.SpinnerOptions(200)),this.typeIdValidatingSpinner=new h.Spinner(new h.SpinnerOptions(200)),this.typeId=ko.observable(),this.typeText=ko.observable("[Loading...]"),this.ceebCode=ko.observable(),this.uCosmicCode=ko.observable(),this.isEditingTypeId=ko.observable(),this.isValidationSummaryVisible=ko.observable(!1),this.flasherProxy=new App.FlasherProxy,this.languages=ko.observableArray(),this.Names=ko.observableArray(),this.editingName=ko.observable(0),this.NamesSpinner=new h.Spinner(new h.SpinnerOptions(0,!0)),this.urls=ko.observableArray(),this.editingUrl=ko.observable(0),this.urlsSpinner=new h.Spinner(new h.SpinnerOptions(0,!0)),this.sideSwiper=new App.SideSwiper({frameWidth:980,speed:"fast",root:"#establishment_page"}),this.parentSearch=new w.Search(!1),this.sammy=Sammy(),this._findingParent=!1,this.parentEstablishment=ko.observable(),this.parentId=ko.observable(),this.parentIdSaveSpinner=new h.Spinner(new h.SpinnerOptions(200)),this.parentIdValidatingSpinner=new h.Spinner(new h.SpinnerOptions(200)),this.id=n||0,this._initNamesComputeds(),this._initUrlsComputeds(),this.location=new b.Location(this.id),this.typeEmptyText=ko.computed(function(){return t.categories().length>0?"[Select a classification]":"[Loading...]"}),this.typeId.subscribe(function(){for(var u=t.categories(),r,n,i=0;i<u.length;i++)for(r=u[i].types(),n=0;n<r.length;n++)if(r[n].id()==t.typeId()){t.typeText(r[n].text());return}t.typeText("[Unknown]")}),this.typeId.extend({required:{message:"Establishment type is required"}}),this.ceebCode.subscribe(function(){t.ceebCode()&&t.ceebCode($.trim(t.ceebCode()))}),this.ceebCode.extend({validEstablishmentCeebCode:this}),this.uCosmicCode.extend({validEstablishmentUCosmicCode:this}),this.uCosmicCode.subscribe(function(){t.uCosmicCode()&&t.uCosmicCode($.trim(t.uCosmicCode()))}),this.isTypeIdSaveDisabled=ko.computed(function(){return t.typeId.isValidating()||t.uCosmicCode.isValidating()||t.ceebCode.isValidating()||t.typeIdSaveSpinner.isVisible()||t.typeIdValidatingSpinner.isVisible()||t.typeId.error||t.ceebCode.error||t.uCosmicCode.error}),this.parentId.extend({validEstablishmentParentId:this}),i=$.Deferred(),$.get(App.Routes.WebApi.Establishments.Categories.get()).done(function(n){i.resolve(n)}).fail(function(n,t,r){i.reject(n,t,r)}),r=this._loadScalars(),$.when(i,r).then(function(i,r){ko.mapping.fromJS(i,{},t.categories),t._pullScalars(r),n||(t.isEditingTypeId(!0),t.errors.showAllMessages(!1)),t._isInitialized()||t._isInitialized(!0)},function(){}),ko.validation.group(this),this._setupSammy(),this._setupParentComputeds()}return n.prototype.requestNames=function(n){var t=this;this.NamesSpinner.start(),$.get(App.Routes.WebApi.Establishments.Names.get(this.id)).done(function(i){t.receiveNames(i),n&&n(i)})},n.prototype.receiveNames=function(n){ko.mapping.fromJS(n||[],this._NamesMapping,this.Names),this.NamesSpinner.stop(),App.Obtruder.obtrude(document)},n.prototype.addName=function(){var t=new c.ServerNameApiModel(this.id),n;this.Names().length===0&&(t.isOfficialName=!0),n=new c.Name(t,this),this.Names.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},n.prototype._initNamesComputeds=function(){var n=this;ko.computed(function(){$.getJSON(App.Routes.WebApi.Languages.get()).done(function(t){var i=new k.ServerApiModel(undefined,"[Language Neutral]");t.splice(0,0,i),n.languages(t)})}).extend({throttle:1}),this._NamesMapping={create:function(t){return new c.Name(t.data,n)}},this.canAddName=ko.computed(function(){return!n.NamesSpinner.isVisible()&&n.editingName()===0&&n.id!==0}),ko.computed(function(){n.id?n.requestNames():setTimeout(function(){n.NamesSpinner.stop(),n.addName()},0)}).extend({throttle:1})},n.prototype.requestUrls=function(n){var t=this;this.urlsSpinner.start(),$.get(App.Routes.WebApi.Establishments.Urls.get(this.id)).done(function(i){t.receiveUrls(i),n&&n(i)})},n.prototype.receiveUrls=function(n){ko.mapping.fromJS(n||[],this._urlsMapping,this.urls),this.urlsSpinner.stop(),App.Obtruder.obtrude(document)},n.prototype.addUrl=function(){var t=new l.ServerUrlApiModel(this.id),n;this.urls().length===0&&(t.isOfficialUrl=!0),n=new l.Url(t,this),this.urls.unshift(n),n.showEditor(),App.Obtruder.obtrude(document)},n.prototype._initUrlsComputeds=function(){var n=this;this._urlsMapping={create:function(t){return new l.Url(t.data,n)}},this.canAddUrl=ko.computed(function(){return!n.urlsSpinner.isVisible()&&n.editingUrl()===0&&n.id!==0}),ko.computed(function(){n.id?n.requestUrls():setTimeout(function(){n.urlsSpinner.stop(),n.addUrl()},0)}).extend({throttle:1})},n.prototype.submitToCreate=function(n){var t=this,e,f,u;if(!this.id||this.id===0){e=this,this.validatingSpinner.start();var i=this.Names()[0],r=this.urls()[0],o=this.location;if(i.text.isValidating()||r.value.isValidating()||this.ceebCode.isValidating()||this.uCosmicCode.isValidating())return setTimeout(function(){var i=t.submitToCreate(n);return!1},50),!1;this.isValidationSummaryVisible(!0),this.isValid()||this.errors.showAllMessages(),i.isValid()||i.errors.showAllMessages(),r.isValid()||r.errors.showAllMessages(),this.validatingSpinner.stop(),i.isValid()&&r.isValid()&&this.isValid()&&(f=App.Routes.WebApi.Establishments.post(),u=this.serializeData(),u.officialName=i.serializeData(),u.officialUrl=r.serializeData(),u.location=o.serializeData(),this.createSpinner.start(),$.post(f,u).done(function(n,t,i){window.location.href=App.Routes.Mvc.Shared.created({location:i.getResponseHeader("Location")})}).fail(function(n){t.createSpinner.stop(),n.status===400&&(t.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),t.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){t.$genericAlertDialog.dialog("close")}}}))}))}return!1},n.prototype.serializeData=function(){var n={};return n.parentId=this.parentId(),n.typeId=this.typeId(),n.ceebCode=this.ceebCode(),n.uCosmicCode=this.uCosmicCode(),n},n.prototype._loadScalars=function(){var n=$.Deferred();return this.id?$.get(App.Routes.WebApi.Establishments.get(this.id)).done(function(t){n.resolve(t)}).fail(function(t,i,r){n.reject(t,i,r)}):n.resolve(undefined),n},n.prototype._pullScalars=function(n){this.originalValues(n),n&&ko.mapping.fromJS(n,{ignore:["id"]},this)},n.prototype.clickToEditTypeId=function(){this.isEditingTypeId(!0)},n.prototype.clickToSaveTypeId=function(){var n=this,t,i,r;if(this.id){if(this.ceebCode.isValidating()||this.uCosmicCode.isValidating()){this.typeIdValidatingSpinner.start(),window.setTimeout(function(){n.clickToSaveTypeId()},50);return}this.typeIdValidatingSpinner.stop(),this.isValid()?(this.typeIdSaveSpinner.start(),t=this.serializeData(),i=this.originalValues(),t.parentId=i.parentId,r=App.Routes.WebApi.Establishments.put(this.id),$.ajax({url:r,type:"PUT",data:t}).always(function(){n.typeIdSaveSpinner.stop()}).done(function(t){App.flasher.flash(t),n.typeIdSaveSpinner.stop(),n.clickToCancelTypeIdEdit()})):this.errors.showAllMessages()}},n.prototype.clickToCancelTypeIdEdit=function(){var n=this;this.isEditingTypeId(!1),this._loadScalars().done(function(t){n._pullScalars(t)})},n.prototype._setupSammy=function(){var t=this,n=this;this.parentSearch.sammyBeforeRoute=/\#\/select-parent\/page\/(.*)\//,this.parentSearch.sammyGetPageRoute="#/select-parent/page/:pageNumber/",this.parentSearch.initDefaultPageRoute=!1,this.parentSearch.setLocation=function(){var n="#/select-parent/page/"+t.parentSearch.pageNumber()+"/";t.parentSearch.sammy.getLocation()!==n&&t.parentSearch.sammy.setLocation(n)},this.parentSearch.clickAction=function(n){return t.parentEstablishment(n),t.parentId(n.id()),t.sammy.setLocation("/Shared/"+t.id+"/#/"),!1},this.parentSearch.detailHref=function(){return"#/"},this.parentSearch.detailTooltip=function(){return"Choose this establishment as the parent"},this.parentSearch.sammy.run(),this.sammy.get("/#/select-parent/page/:pageNumber/",function(){n._findingParent?n.parentSearch.getPage(this.params.pageNumber):(n._findingParent=!0,n._parentScrollTop=App.WindowScroller.getTop(),n.sideSwiper.next(),n.parentSearch.pageNumber(1),n.parentSearch.transitionedPageNumber(1))}),this.sammy.get("/Shared/:establishmentId/#/",function(){n._findingParent&&(n.sideSwiper.prev(1,function(){App.WindowScroller.setTop(n._parentScrollTop)}),n._findingParent=!1)}),this.sammy.setLocation("#/")},n.prototype._setupParentComputeds=function(){var n=this,t=this.parentId();this.isParentDirty=ko.computed(function(){var i=n.parentId(),t=n.originalValues();return n.id?t?i!=t.parentId:!1:!1}),this.hasParent=ko.computed(function(){return n.parentId()!==undefined&&n.parentId()>0}),this.isParentIdSaveDisabled=ko.computed(function(){return n.parentId.isValidating()||n.parentIdSaveSpinner.isVisible()||n.parentIdValidatingSpinner.isVisible()||n.parentId.error}),this.parentId.subscribe(function(t){if(t){var i=App.Routes.WebApi.Establishments.get();$.get(i,{id:t}).done(function(t){if(t&&t.items&&t.items.length){var i=t.items[0];n.parentEstablishment(new p.SearchResult(i,n.parentSearch))}})}else n.parentEstablishment(undefined)})},n.prototype.clearParent=function(n,t){this.parentId(undefined),t.stopPropagation()},n.prototype.clickToCancelParentIdEdit=function(){this.parentId(this.originalValues().parentId)},n.prototype.clickToSaveParentId=function(){var t=this,n,i,r;if(this.id){if(this.parentId.isValidating()){this.parentIdValidatingSpinner.start(),window.setTimeout(function(){t.clickToSaveParentId()},50);return}this.parentIdValidatingSpinner.stop(),this.isValid()?(this.parentIdSaveSpinner.start(),n=this.serializeData(),i=this.originalValues(),n.typeId=i.typeId,n.ceebCode=i.ceebCode,n.uCosmicCode=i.uCosmicCode,r=App.Routes.WebApi.Establishments.put(this.id),$.ajax({url:r,type:"PUT",data:n}).always(function(){t.parentIdSaveSpinner.stop()}).done(function(i){App.flasher.flash(i),t.parentIdSaveSpinner.stop();var r=t.originalValues();r.parentId=n.parentId,t.originalValues(r)})):this.errors.showAllMessages()}},n}(),t.Item=y})