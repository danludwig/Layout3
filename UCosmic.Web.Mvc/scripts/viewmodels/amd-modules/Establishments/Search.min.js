var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i};define(["require","exports","../Widgets/PagedSearch","./SearchResult","../places/ServerApiModel"],function(n,t,i,r,u){var f=i,e=r,o=u,s=function(n){function t(t){typeof t=="undefined"&&(t=!0);var i=this;n.call(this),this.initDefaultPageRoute=t,this.sammy=Sammy(),this.sammyBeforeRoute=/\#\/page\/(.*)\//,this.sammyGetPageRoute="#/page/:pageNumber/",this.sammyDefaultPageRoute="/Establishments[/]?",this.countries=ko.observableArray(),this.countryCode=ko.observable(),this.lenses=ko.observableArray([{text:"Table",value:"table"},{text:"List",value:"list"}]),this.lens=ko.observable(),this.$itemsPage=undefined,this.sideSwiper=new App.SideSwiper({frameWidth:710,speed:"fast",root:"#search"}),this.trail=ko.observableArray([]),this.resultsMapping={items:{key:function(n){return ko.utils.unwrapObservable(n.id)},create:function(n){return new e.SearchResult(n.data,n.parent)}},ignore:["pageSize","pageNumber"]},this._setupCountryDropDown(),this._setupPagingSubscriptions(),this._setupLensing(),this._setupSammy(),ko.computed(function(){i.requestResults()}).extend({throttle:1})}return __extends(t,n),t.prototype._setupCountryDropDown=function(){var n=this;ko.computed(function(){var t=$('input[type=hidden][data-bind="value: countryCode"]').val();$.get(App.Routes.WebApi.Countries.get()).done(function(i){var r=new o.ServerCountryApiModel("-1","[Without country]");i.splice(i.length,0,r),n.countries(i),t&&t!==n.countryCode()&&n.countryCode(t)})}).extend({throttle:1})},t.prototype._setupPagingSubscriptions=function(){var n=this;this.pageNumber.subscribe(function(){n.setLocation()})},t.prototype._setupLensing=function(){var n=this;this.changeLens=function(t){n.lens(t.value)}},t.prototype._setupSammy=function(){var n=this;n.sammy.before(n.sammyBeforeRoute,function(){n.beforePage(this)}),n.sammy.get(n.sammyGetPageRoute,function(){n.getPage(this)}),n.initDefaultPageRoute&&n.sammy.get(n.sammyDefaultPageRoute,function(){n.initPageHash(this)})},t.prototype.getPage=function(n){var t=this,i=this.trail(),r;if(!(i.length>0)||i[i.length-1]!==n.path){if(i.length>1&&i[i.length-2]===n.path){i.pop(),this.swipeCallback=function(){r=t.$itemsPage.clone(!0).removeAttr("data-bind").data("bind",undefined).removeAttr("id"),r.appendTo(t.$itemsPage.parent()),t.$itemsPage.attr("data-side-swiper","off").hide(),t.lockAnimation(),$(window).scrollTop(0),t.sideSwiper.prev(1,function(){t.$itemsPage.siblings().remove(),t.unlockAnimation()})};return}i.length>0&&(this.swipeCallback=function(){r=t.$itemsPage.clone(!0).removeAttr("data-bind").data("bind",undefined).removeAttr("id"),r.insertBefore(t.$itemsPage),t.$itemsPage.attr("data-side-swiper","off").hide(),t.lockAnimation(),$(window).scrollTop(0),t.sideSwiper.next(1,function(){t.unlockAnimation()})}),i.push(n.path)}},t.prototype.beforePage=function(n){if(this.nextForceDisabled()||this.prevForceDisabled())return!1;var t=n.params.pageNumber;return t&&parseInt(t)!==parseInt(this.pageNumber())&&this.pageNumber(parseInt(t)),!0},t.prototype.initPageHash=function(n){n.app.setLocation("#/page/1/")},t.prototype.setLocation=function(){var n="#/page/"+this.pageNumber()+"/";this.sammy.getLocation()!==n&&this.sammy.setLocation(n)},t.prototype.lockAnimation=function(){this.nextForceDisabled(!0),this.prevForceDisabled(!0)},t.prototype.unlockAnimation=function(){this.nextForceDisabled(!1),this.prevForceDisabled(!1)},t.prototype.swipeCallback=function(){},t.prototype.receiveResults=function(n){n?ko.mapping.fromJS(n,this.resultsMapping,this):ko.mapping.fromJS({items:[],itemTotal:0},this.resultsMapping,this),App.WindowScroller.restoreTop(),this.spinner.stop(),this.swipeCallback(),this.transitionedPageNumber(this.pageNumber())},t.prototype.requestResults=function(){var n=this;this.pageSize()!==undefined&&this.orderBy()!==undefined&&(this.spinner.start(),$.get(App.Routes.WebApi.Establishments.get(),{pageSize:this.pageSize(),pageNumber:this.pageNumber(),countryCode:this.countryCode(),keyword:this.throttledKeyword(),orderBy:this.orderBy()}).done(function(t){n.receiveResults(t)}))},t.prototype.gotoAddNew=function(){return!0},t.prototype.clickAction=function(){return!0},t.prototype.detailHref=function(n){return App.Routes.Mvc.Shared.show(n)},t.prototype.detailTooltip=function(){return"View & edit this establishment's details"},t}(f.PagedSearch);t.Search=s})