define(["require","exports","./ServerApiModel","../Widgets/Spinner"],function(n,t,i,r){var s=i,u=r,f=function(){function n(n){this.id=0,this.ownerId=0,this.value="",this.isOfficialUrl=!1,this.isFormerUrl=!1,this.ownerId=n}return n}(),e,o;t.ServerUrlApiModel=f,e=function(){function n(){this._ruleName="validEstablishmentUrlValue",this._isAwaitingResponse=!1,this.async=!0,this.message="error",ko.validation.rules[this._ruleName]=this,ko.validation.addExtender(this._ruleName)}return n.prototype.validator=function(n,t,i){var u=this,r;t.isValueValidatableAsync()?!this._isAwaitingResponse&&t.value()&&(r=App.Routes.WebApi.Establishments.Urls.validateValue(t.ownerId(),t.id()),this._isAwaitingResponse=!0,$.post(r,t.serializeData()).always(function(){u._isAwaitingResponse=!1}).done(function(){i(!0)}).fail(function(n){i({isValid:!1,message:n.responseText})})):i(!0)},n}(),new e,o=function(){function n(n,t){var i=this;this.id=ko.observable(),this.ownerId=ko.observable(),this.value=ko.observable(),this.isOfficialUrl=ko.observable(),this.isFormerUrl=ko.observable(),this.editMode=ko.observable(),this.$valueElement=undefined,this.$confirmPurgeDialog=undefined,this.saveSpinner=new u.Spinner(new u.SpinnerOptions(0,!1)),this.purgeSpinner=new u.Spinner(new u.SpinnerOptions(0,!1)),this.valueValidationSpinner=new u.Spinner(new u.SpinnerOptions(0,!1)),this.saveEditorClicked=!1,this.owner=t,n||(n=new f(this.owner.id)),n.id===0&&(n.ownerId=this.owner.id),this.originalValues=n,ko.mapping.fromJS(n,{},this),this.isOfficialUrlEnabled=ko.computed(function(){return!i.originalValues.isOfficialUrl}),this.isValueValidatableAsync=ko.computed(function(){return i.value()!==i.originalValues.value}),this.value.extend({maxLength:200,validEstablishmentUrlValue:this}),this.owner.id&&this.value.extend({required:{message:"Establishment URL is required."}}),this.value.isValidating.subscribe(function(n){n?i.valueValidationSpinner.start():(i.valueValidationSpinner.stop(),i.saveEditorClicked&&i.saveEditor())}),this.isOfficialUrl.subscribe(function(n){n&&i.isFormerUrl(!1)}),this.valueHref=ko.computed(function(){var n=i.value();return n?"http://"+n:n}),this.isDeletable=ko.computed(function(){return i.owner.editingUrl()?!1:i.owner.urls().length==1?!0:!i.isOfficialUrl()}),this.mutationSuccess=function(n){i.owner.requestUrls(function(){i.owner.editingUrl(0),i.editMode(!1),i.saveSpinner.stop(),i.purgeSpinner.stop(),App.flasher.flash(n)})},this.mutationError=function(n){n.status===400&&(i.owner.$genericAlertDialog.find("p.content").html(n.responseText.replace("\n","<br /><br />")),i.owner.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.owner.$genericAlertDialog.dialog("close")}}})),i.saveSpinner.stop(),i.purgeSpinner.stop()},ko.validation.group(this)}return n.prototype.clickLink=function(n,t){return t.stopPropagation(),!0},n.prototype.clickOfficialUrlCheckbox=function(){var n=this;return this.originalValues.isOfficialUrl&&(this.owner.$genericAlertDialog.find("p.content").html("In order to choose a different official URL for this establishment, edit the URL you wish to make the new official URL."),this.owner.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){n.owner.$genericAlertDialog.dialog("close")}}})),!0},n.prototype.showEditor=function(){var n=this.owner.editingUrl();n||(this.owner.editingUrl(this.id()||-1),this.editMode(!0),this.$valueElement.trigger("autosize"),this.$valueElement.focus())},n.prototype.saveEditor=function(){return this.saveEditorClicked=!0,this.isValid()?this.value.isValidating()||(this.saveEditorClicked=!1,this.saveSpinner.start(),this.id()?$.ajax({url:App.Routes.WebApi.Establishments.Urls.put(this.owner.id,this.id()),type:"PUT",data:this.serializeData()}).done(this.mutationSuccess).fail(this.mutationError):this.owner.id&&$.ajax({url:App.Routes.WebApi.Establishments.Urls.post(this.owner.id),type:"POST",data:this.serializeData()}).done(this.mutationSuccess).fail(this.mutationError)):(this.saveEditorClicked=!1,this.errors.showAllMessages()),!1},n.prototype.cancelEditor=function(){this.owner.editingUrl(0),this.id()?(ko.mapping.fromJS(this.originalValues,{},this),this.editMode(!1)):this.owner.urls.shift()},n.prototype.purge=function(n,t){var i=this,r;if(t.stopPropagation(),!this.owner.editingUrl()){if(this.isOfficialUrl()&&this.owner.urls().length>1){this.owner.$genericAlertDialog.find("p.content").html("You cannot delete an establishment's official URL.<br />To delete this URL, first assign another URL as official."),this.owner.$genericAlertDialog.dialog({title:"Alert Message",dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,buttons:{Ok:function(){i.owner.$genericAlertDialog.dialog("close")}}});return}this.purgeSpinner.start(),r=!1,this.$confirmPurgeDialog.dialog({dialogClass:"jquery-ui",width:"auto",resizable:!1,modal:!0,close:function(){r||i.purgeSpinner.stop()},buttons:[{text:"Yes, confirm delete",click:function(){r=!0,i.$confirmPurgeDialog.dialog("close"),$.ajax({url:App.Routes.WebApi.Establishments.Urls.del(i.owner.id,i.id()),type:"DELETE"}).done(i.mutationSuccess).fail(i.mutationError)}},{text:"No, cancel delete",click:function(){i.$confirmPurgeDialog.dialog("close"),i.purgeSpinner.stop()},"data-css-link":!0}]})}},n.prototype.serializeData=function(){return{id:this.id(),ownerId:this.ownerId(),value:$.trim(this.value()),isOfficialUrl:this.isOfficialUrl(),isFormerUrl:this.isFormerUrl()}},n}(),t.Url=o})