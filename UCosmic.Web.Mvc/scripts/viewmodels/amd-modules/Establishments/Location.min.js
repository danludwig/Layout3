define(["require","exports","../places/ServerApiModel","../Widgets/Spinner"],function(n,t,i,r){var u=i,e=r,f=google.maps,o=function(){function n(n){var t=this;this.mapZoom=ko.observable(1),this.mapTools=ko.observable(),this.$mapCanvas=ko.observable(),this.isMapVisible=ko.observable(),this.isLoaded=ko.observable(),this.continents=ko.observableArray(),this.continentId=ko.observable(),this.countries=ko.observableArray(),this.countryId=ko.observable(),this.allowCountryFitBounds=!0,this.admin1s=ko.observableArray(),this.admin1Id=ko.observable(),this.admin1sLoading=ko.observable(!1),this.admin2s=ko.observableArray(),this.admin2Id=ko.observable(),this.admin2sLoading=ko.observable(!1),this.admin3s=ko.observableArray(),this.admin3Id=ko.observable(),this.admin3sLoading=ko.observable(!1),this.places=ko.observableArray(),this.subAdmins=ko.observableArray(),this.loadSpinner=new e.Spinner(new e.SpinnerOptions(400)),this.saveSpinner=new e.Spinner(new e.SpinnerOptions(400)),this.isEditing=ko.observable(),this.ownerId=n,this._initComputedsAndSubscriptions(),this.loadSpinner.isVisible.subscribe(function(n){t.$dataLoadingDialog&&t.$dataLoadingDialog.length&&(n?t.$dataLoadingDialog.dialog({modal:!0,resizable:!1,dialogClass:"no-close",width:"450px"}):t.$dataLoadingDialog.dialog("close"))}),this.isEditable=ko.computed(function(){return t.ownerId&&t.ownerId!==0}),this.isEditIconVisible=ko.computed(function(){return t.isEditable()&&!t.isEditing()}),this.isEditing.subscribe(function(n){n?t.mapTools().showMarkerTools():t.isEditable()&&t.mapTools().hideMarkerTools()})}return n.prototype._initComputedsAndSubscriptions=function(){var n=this;this.toolsMarkerLat=ko.computed(function(){return n.mapTools()&&n.mapTools().markerLatLng()?n.mapTools().markerLatLng().lat():null}),this.toolsMarkerLng=ko.computed(function(){return n.mapTools()&&n.mapTools().markerLatLng()?n.mapTools().markerLatLng().lng():null}),this.$mapCanvas.subscribe(function(){n.map||n.initMap()}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get(),{isContinent:!0}).done(function(t){n.continents(t)})}).extend({throttle:1}),this.continentName=ko.computed(function(){var i=n.continentId(),t;return i?(t=u.Utils.getPlaceById(n.continents(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"}),this.countryOptionsCaption=ko.computed(function(){return n.countries().length>0?"[Unspecified]":"[Loading...]"}),ko.computed(function(){$.get(App.Routes.WebApi.Places.get(),{isCountry:!0}).done(function(t){if(n.countries(t),n._countryId){var i=n._countryId;n._countryId=undefined,n.countryId(i)}})}).extend({throttle:1}),this.countryName=ko.computed(function(){var i=n.countryId(),t;return i?(t=u.Utils.getPlaceById(n.countries(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"}),this.countryId.subscribe(function(t){if(t&&n.countries().length==0&&(n._countryId=t),t&&n.countries().length>0){var i=u.Utils.getPlaceById(n.countries(),t);i&&(n.allowCountryFitBounds?n.map.fitBounds(u.Utils.convertToLatLngBounds(i.box)):setTimeout(function(){n.allowCountryFitBounds=!0},1e3),n.continentId(i.parentId),n.loadAdmin1s(i.id))}else!t&&n.countries().length>0&&(n.map.setCenter(new f.LatLng(0,0)),n.allowCountryFitBounds?n.map.setZoom(1):setTimeout(function(){n.allowCountryFitBounds=!0},1e3),n.continentId(null))}),this.admin1OptionsCaption=ko.computed(function(){return n.admin1sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin1Input=ko.computed(function(){return n.countryId()&&(n.admin1s().length>0||n.admin1sLoading())}),this.admin1Id.subscribe(function(t){if(t&&n.admin1s().length==0&&(n._admin1Id=t),t&&n.admin1s().length>0){var i=u.Utils.getPlaceById(n.admin1s(),t);i?n.loadAdmin2s(i.id):(n._admin1Id=t,n.loadAdmin1s(n.countryId()||n._countryId))}}),this.admin1Name=ko.computed(function(){var i=n.admin1Id(),t;return i?(t=u.Utils.getPlaceById(n.admin1s(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"}),this.admin2OptionsCaption=ko.computed(function(){return n.admin2sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin2Input=ko.computed(function(){return n.countryId()&&n.admin1Id()&&(n.admin2s().length>0||n.admin2sLoading())}),this.admin2Id.subscribe(function(t){if(t&&n.admin2s().length==0&&(n._admin2Id=t),t&&n.admin2s().length>0){var i=u.Utils.getPlaceById(n.admin2s(),t);i?n.loadAdmin3s(i.id):(n._admin2Id=t,n.loadAdmin2s(n.admin1Id()||n._admin1Id))}}),this.admin2Name=ko.computed(function(){var i=n.admin2Id(),t;return i?(t=u.Utils.getPlaceById(n.admin2s(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"}),this.admin3OptionsCaption=ko.computed(function(){return n.admin3sLoading()?"[Loading...]":"[Unspecified]"}).extend({throttle:400}),this.showAdmin3Input=ko.computed(function(){return n.countryId()&&n.admin1Id()&&n.admin2Id()&&(n.admin3s().length>0||n.admin3sLoading())}),this.admin3Id.subscribe(function(t){if(t&&n.admin3s().length==0&&(n._admin3Id=t),t&&n.admin3s().length>0){var i=u.Utils.getPlaceById(n.admin3s(),t);i||(n._admin3Id=t,n.loadAdmin3s(n.admin2Id()||n._admin2Id))}}),this.admin3Name=ko.computed(function(){var i=n.admin3Id(),t;return i?(t=u.Utils.getPlaceById(n.admin3s(),i),t?t.officialName:"[Unknown]"):"[Unspecified]"})},n.prototype.initMap=function(){var n=this,t=this,i={mapTypeId:f.MapTypeId.ROADMAP,center:new f.LatLng(0,0),zoom:t.mapZoom(),draggable:!0,scrollwheel:!1};this.map=new f.Map(this.$mapCanvas()[0],i),this.isMapVisible(!0),f.event.addListenerOnce(this.map,"idle",function(){n.mapTools(new App.GoogleMaps.ToolsOverlay(n.map)),n.mapTools().hideMarkerTools(),f.event.addListener(n.map,"zoom_changed",function(){n.mapZoom(n.map.getZoom())})});this.$mapCanvas().on("marker_destroyed",function(){var t=n.map.getCenter(),i=n.map.getZoom();n.countryId(undefined),n.continentId(undefined),n.admin1Id(undefined),n.admin2Id(undefined),n.admin3Id(undefined),n.subAdmins([]),n.map.setCenter(t),n.map.setZoom(i)});this.$mapCanvas().on("marker_dragend marker_created",function(){var t=n.mapTools().markerLatLng(),i=App.Routes.WebApi.Places.ByCoordinates.get(t.lat(),t.lng());n.loadSpinner.start(),$.get(i).done(function(t){t&&t.length&&(n.allowCountryFitBounds=!1,n.fillPlacesHierarchy(t))}).always(function(){n.loadSpinner.stop()}).fail(function(){})});this.ownerId?(this.isLoaded(!1),$.get(App.Routes.WebApi.Establishments.Locations.get(this.ownerId)).done(function(t){f.event.addListenerOnce(n.map,"idle",function(){n.loadMapZoom(t),n.loadMapMarker(t)}),n.fillPlacesHierarchy(t.places),n.isLoaded(!0)})):f.event.addListenerOnce(this.map,"idle",function(){n.isEditing(!0)})},n.prototype.loadMapZoom=function(n){n.googleMapZoomLevel&&n.center&&n.center.hasValue?this.map.setZoom(n.googleMapZoomLevel):n.box.hasValue&&this.map.fitBounds(u.Utils.convertToLatLngBounds(n.box)),n.googleMapZoomLevel&&n.googleMapZoomLevel>1&&this.map.setZoom(n.googleMapZoomLevel),(n.googleMapZoomLevel||n.box.hasValue)&&(this.allowCountryFitBounds=!1)},n.prototype.loadMapMarker=function(n){if(n.center.hasValue){var t=u.Utils.convertToLatLng(n.center);this.mapTools().placeMarker(t),this.map.setCenter(t)}},n.prototype.fillPlacesHierarchy=function(n){var i,r,f,e,o,t;this.places(n),i=u.Utils.getContinent(n),i&&this.continentId(i.id),r=u.Utils.getCountry(n),r?this.countryId(r.id):this.countryId(undefined),f=u.Utils.getAdmin1(n),f?this.admin1Id(f.id):this.admin1Id(undefined),e=u.Utils.getAdmin2(n),e?this.admin2Id(e.id):this.admin2Id(undefined),o=u.Utils.getAdmin3(n),o?this.admin3Id(o.id):this.admin3Id(undefined),t=u.Utils.getSubAdmins(n),t&&t.length?this.subAdmins(t):this.subAdmins([])},n.prototype.loadAdmin1s=function(n){var t=this,i=App.Routes.WebApi.Places.get();this.admin1sLoading(!0),$.ajax({type:"GET",url:i,data:{isAdmin1:!0,parentId:n},cache:!1}).done(function(n){t.admin1s(n),t._admin1Id&&t.admin1Id(t._admin1Id),t.admin1sLoading(!1)})},n.prototype.loadAdmin2s=function(n){var t=this,i=App.Routes.WebApi.Places.get();this.admin2sLoading(!0),$.ajax({type:"GET",data:{isAdmin2:!0,parentId:n},url:i,cache:!1}).done(function(n){t.admin2s(n),t._admin2Id&&t.admin2Id(t._admin2Id),t.admin2sLoading(!1)})},n.prototype.loadAdmin3s=function(n){var t=this,i=App.Routes.WebApi.Places.get();this.admin3sLoading(!0),$.ajax({type:"GET",data:{isAdmin3:!0,parentId:n},url:i,cache:!1}).done(function(n){t.admin3s(n),t._admin3Id&&t.admin3Id(t._admin3Id),t.admin3sLoading(!1)})},n.prototype.changePlaceInLocation=function(){this.subAdmins([])},n.prototype.clickToEdit=function(){this.isEditing(!0)},n.prototype.clickToSave=function(){var t=this,n=this;this.ownerId&&(this.saveSpinner.start(),$.ajax({url:App.Routes.WebApi.Establishments.Locations.put(n.ownerId),type:"PUT",data:n.serializeData()}).always(function(){n.saveSpinner.stop()}).done(function(n){App.flasher.flash(n),t.isEditing(!1)}).fail(function(){}))},n.prototype.serializeData=function(){var t,r=this.toolsMarkerLat(),f=this.toolsMarkerLng(),i=this.map.getZoom();r!=null&&f!=null&&(t={latitude:r,longitude:f}),t&&this.map.setCenter(u.Utils.convertToLatLng(t));var e,o=this.map.getBounds().getNorthEast().lat(),s=this.map.getBounds().getNorthEast().lng(),h=this.map.getBounds().getSouthWest().lat(),c=this.map.getBounds().getSouthWest().lng(),n;return i&&i>1&&(e={northEast:{latitude:o,longitude:s},southWest:{latitude:h,longitude:c}}),this.subAdmins().length?n=this.subAdmins()[this.subAdmins().length-1].id:this.admin3Id()?n=this.admin3Id():this.admin2Id()?n=this.admin2Id():this.admin1Id()?n=this.admin1Id():this.countryId()?n=this.countryId():this.continentId()&&(n=this.continentId()),{center:t,box:e,googleMapZoomLevel:i,placeId:n}},n.prototype.clickToCancelEdit=function(){var n=this;(this.isEditing(!1),this.ownerId)&&(this.isLoaded(!1),$.get(App.Routes.WebApi.Establishments.Locations.get(this.ownerId)).done(function(t){n.map.setZoom(1),n.loadMapZoom(t),n.mapTools().destroyMarker(),n.loadMapMarker(t),n.fillPlacesHierarchy(t.places),n.isLoaded(!0)}))},n.prototype.clickForHelp=function(){alert("TODO: Show location help dialog here.")},n}();t.Location=o})