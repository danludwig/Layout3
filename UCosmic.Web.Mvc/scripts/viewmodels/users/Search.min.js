var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},ViewModels;(function(n){(function(t){var u=function(t){function i(){t.call(this),this.sammy=Sammy(),this.$historyJson=ko.observable(),this._history=ko.observableArray([]),this._historyIndex=0,this.impersonateUserName=ko.observable(),this.flasherProxy=new App.FlasherProxy,this._init()}return __extends(i,t),i.prototype._init=function(){this._setupHistory(),this._setupSammy(),this._setupQueryComputed(),this._setupPagingDefaults()},i.prototype._pullResults=function(){var n=this,t=$.Deferred(),i={pageSize:this.pageSize(),pageNumber:this.pageNumber(),keyword:this.throttledKeyword(),orderBy:this.orderBy()};return this.spinner.start(),this.nextForceDisabled(!0),this.prevForceDisabled(!0),$.get(App.Routes.WebApi.Identity.Users.get(),i).done(function(n,i,r){t.resolve(n,i,r)}).fail(function(n,i,r){t.reject(n,i,r)}).always(function(){n.spinner.stop(),n.nextForceDisabled(!1),n.prevForceDisabled(!1)}),t},i.prototype._loadResults=function(t){var i=this,r={items:{key:function(n){return ko.utils.unwrapObservable(n.id)},create:function(t){return new n.Users.SearchResult(t.data,i)}},ignore:["pageSize","pageNumber"]};ko.mapping.fromJS(t,r,this),this.transitionedPageNumber(this.pageNumber())},i.prototype._setupQueryComputed=function(){var n=this;ko.computed(function(){n.pageSize()!==undefined&&n.orderBy()!==undefined&&n._pullResults().done(function(t){n._loadResults(t)}).fail(function(){})}).extend({throttle:250})},i.prototype._setupSammy=function(){var t=this,n=this;this.sammy.before(/\#\/page\/(.*)/,function(){var i,t,r;if(n.nextForceDisabled()||n.prevForceDisabled())return!1;if(n._history().length>1)for(i=this.path,t=0;t<n._history().length;t++)if(r=n._history()[t],i===r)return n._historyIndex=t,!0;return n._history.push(this.path),n._historyIndex=n._history().length-1,!0}),this.sammy.get(this.getPageHash(":pageNumber"),function(){var t=this.params.pageNumber;t&&parseInt(t)!==parseInt(n.pageNumber())&&n.pageNumber(parseInt(t)),document.title="Users (Page #"+n.pageNumber()+")"}),this.sammy.get("/users[/]?",function(){t.sammy.setLocation(t.getPageHash(1))})},i.prototype._setupHistory=function(){var n=this;this.$historyJson.subscribe(function(t){var i,r;t&&t.length&&(i=t.val(),i&&(r=$.parseJSON(i),ko.mapping.fromJS(r,{},n._history)))}),this._history.subscribe(function(t){if(n.$historyJson()&&n.$historyJson().length){var r=n.$historyJson().val(),i=ko.toJSON(t);r!==i&&n.$historyJson().val(i)}})},i.prototype._setupPagingDefaults=function(){this.orderBy($('input[type=hidden][data-bind*="value: orderBy"]').val()),this.pageSize($('input[type=hidden][data-bind*="value: pageSize"]').val())},i.prototype.nextPage=function(){this._gotoPage(1)},i.prototype.prevPage=function(){this._gotoPage(-1)},i.prototype._gotoPage=function(n){var u,i,f,e,r;if(n!=0&&(u=n<0?this.prevEnabled():this.nextEnabled(),u&&(i=parseInt(this.pageNumber())+n,i>0&&i<=this.pageCount()))){if(this._history().length>1)for(var o=location.pathname+this.getPageHash(i),t=n<0?0:this._history().length-1,s=function(){n<0?t++:t--};t<this._history().length&&t>=0;s())if(f=this._history()[t],o===f){e=t-this._historyIndex,history.go(e),this._historyIndex=t;return}this.pageNumber(i),r=this.getPageHash(i),this.sammy.getLocation()!==r&&this.sammy.setLocation(r)}},i}(n.PagedSearch),i,r;t.Search=u,i=function(){function t(t,i){var u=this,r;this.roleOptions=ko.observableArray(),this.selectedRoleOption=ko.observable(),this.roleSpinner=new n.Spinner({delay:0,isVisible:!0}),this.$menu=ko.observable(),this.isEditingRoles=ko.observable(!1),this._owner=i,r={roles:{create:function(t){return new n.Users.RoleGrant(t.data,u)}}},ko.mapping.fromJS(t,r,this),this._setupPhotoComputeds(),this._setupNamingComputeds(),this._setupRoleGrantComputeds(),this._setupMenuSubscription()}return t.prototype._setupPhotoComputeds=function(){var n=this;this.photoSrc=ko.computed(function(){return App.Routes.WebApi.People.Photo.get(n.personId(),100)})},t.prototype._setupNamingComputeds=function(){var n=this;this.hasUniqueDisplayName=ko.computed(function(){return n.name()!==n.personDisplayName()})},t.prototype._setupRoleGrantComputeds=function(){var n=this;this.hasGrants=ko.computed(function(){return n.roles().length>0}),this.hasNoGrants=ko.computed(function(){return!n.hasGrants()}),this.isRoleGrantDisabled=ko.computed(function(){return n.roleSpinner.isVisible()||!n.selectedRoleOption()})},t.prototype._setupMenuSubscription=function(){this.$menu.subscribe(function(n){n&&n.length&&n.kendoMenu()})},t.prototype._pullRoleOptions=function(){var i=this,n,t;return this.selectedRoleOption(undefined),this.roleSpinner.start(),n=$.Deferred(),t={pageSize:Math.pow(2,32)/2-1,orderBy:"name-asc"},$.get(App.Routes.WebApi.Identity.Roles.get(),t).done(function(t,i,r){n.resolve(t,i,r)}).fail(function(t,i,r){n.reject(t,i,r)}).always(function(){i.roleSpinner.stop()}),n},t.prototype._loadRoleOptions=function(n){var t,r,i,u;for(ko.mapping.fromJS(n.items,{},this.roleOptions),t=0;t<this.roleOptions().length;t++)for(r=this.roleOptions()[t],i=0;i<this.roles().length;i++)u=this.roles()[i],r.id()==u.id()&&(t===0?this.roleOptions.shift():t==this.roleOptions().length?this.roleOptions.pop():this.roleOptions.splice(t,1),t=-1)},t.prototype.pullRoleGrants=function(){var t=this,n;return this.roleSpinner.start(),n=$.Deferred(),$.get(App.Routes.WebApi.Identity.Users.Roles.get(this.id())).done(function(t,i,r){n.resolve(t,i,r)}).fail(function(t,i,r){n.reject(t,i,r)}).always(function(){t.roleSpinner.stop()}),n},t.prototype.loadRoleGrants=function(t){var i=this,r={create:function(t){return new n.Users.RoleGrant(t.data,i)}};ko.mapping.fromJS(t,r,this.roles)},t.prototype.impersonate=function(){var n=this._owner.impersonateForm;n&&(this._owner.impersonateUserName(this.name()),$(n).submit())},t.prototype.showRoleEditor=function(){var n=this;this.isEditingRoles(!0),this._pullRoleOptions().done(function(t){n._loadRoleOptions(t)})},t.prototype.hideRoleEditor=function(){this.isEditingRoles(!1)},t.prototype.grantRole=function(){var n=this,t;this.roleSpinner.start(),t=App.Routes.WebApi.Identity.Roles.Grants.put(this.selectedRoleOption(),this.id()),$.ajax({url:t,type:"PUT"}).done(function(t){App.flasher.flash(t),n.pullRoleGrants().done(function(t){n.loadRoleGrants(t),n._pullRoleOptions().done(function(t){n._loadRoleOptions(t)})})}).fail(function(){alert("fail")})},t.prototype.revokeRole=function(n){var t=this,i;this.roleSpinner.start(),i=App.Routes.WebApi.Identity.Roles.Grants.del(n,this.id()),$.ajax({url:i,type:"DELETE"}).done(function(n){App.flasher.flash(n),t.pullRoleGrants().done(function(n){t.loadRoleGrants(n),t._pullRoleOptions().done(function(n){t._loadRoleOptions(n)})})}).fail(function(n){alert("fail "+n.responseText)})},t}(),t.SearchResult=i,r=function(){function n(n,t){this._owner=t,ko.mapping.fromJS(n,{},this)}return n.prototype.revokeRole=function(){this._owner.revokeRole(this.id())},n}(),t.RoleGrant=r})(n.Users||(n.Users={}));var t=n.Users})(ViewModels||(ViewModels={}))