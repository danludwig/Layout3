define(function(t,e,n){"use strict";var i=t("riot-observable");var r=/^.+?\/+[^\/]+/,f="EventListener",o="remove"+f,s="add"+f,u="hasAttribute",a="replace",c="popstate",h="trigger",l=window,p=document,d=l.history.location||l.location,v=N.prototype,m=p&&p.ontouchstart?"touchstart":"click",b=false,g=i(),w,y,$,x;function A(t){return t.split(/[\/?#]/)}function K(t,e){var n=new RegExp("^"+e[a](/\*/g,"([^/?#]+?)")[a](/\.\./,".*")+"$"),i=t.match(n);if(i)return i.slice(1)}function N(){this.$=[];i(this);g.on("stop",this.s.bind(this));g.on("emit",this.e.bind(this))}function E(t){return t[a](/^\/|\/$/,"")}function k(t){return(t||d.href)[a](r,"")}function q(t){return w[0]=="#"?(t||d.href).split(w)[1]||"":k(t)[a](w,"")}function D(t){var e=q();if(t||e!=y){g[h]("emit",e);y=e}}function L(t){if(t.which!=1||t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;var e=t.target;while(e&&e.nodeName!="A")e=e.parentNode;if(!e||e.nodeName!="A"||e[u]("download")||!e[u]("href")||e.target&&e.target!="_self"||e.href.indexOf(d.href.match(r)[0])==-1)return;if(e.href!=d.href){if(e.href.split("#")[0]==d.href.split("#")[0])return;O(q(e.href),e.title||p.title)}t.preventDefault()}function O(t,e){e=e||p.title;history.pushState(null,e,w+t);p.title=e;D()}v.m=function(t,e){if(t[0]&&(!e||e[0]))O(t,e);else if(e)this.r(t,e);else this.r("@",t)};v.s=function(){this.off("*");this.$=[]};v.e=function(t){this.$.concat("@").some(function(e){var n=(e=="@"?$:x)(E(t),E(e));if(n){this[h].apply(null,[e].concat(n));return true}},this)};v.r=function(t,e){if(t!="@")this.$.push(t);this.on(t,e)};var P=new N;var R=P.m.bind(P);R.create=function(){var t=new N;t.m.stop=t.s.bind(t);return t.m.bind(t)};R.base=function(t){w=t||"#";y=q()};R.exec=function(){D(true)};R.parser=function(t,e){if(!t&&!e){$=A;x=K}if(t)$=t;if(e)x=e};R.query=function(){var t={};d.href[a](/[?&](.+?)=([^&]*)/g,function(e,n,i){t[n]=i});return t};R.stop=function(){if(b){l[o](c,D);p[o](m,L);g[h]("stop");b=false}};R.start=function(){if(!b){l[s](c,D);p[s](m,L);b=true}};R.base();R.parser();n.exports=R});