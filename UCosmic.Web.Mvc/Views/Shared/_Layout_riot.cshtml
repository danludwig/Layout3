<!DOCTYPE html>
@{
    var tenancy = Request.Tenancy();
    var styleDomain = tenancy != null ? tenancy.StyleDomain : "default";
    var hasStyleDomain = !string.IsNullOrWhiteSpace(styleDomain) && !"default".Equals(styleDomain, StringComparison.OrdinalIgnoreCase);
}
@using UCosmic.Web.Mvc.Models
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, maximum-scale=1.0" />
    <title>@ViewBag.Title</title>
    @*@Styles.Render("~/content/themes/base/css")*@
    @*@Styles.Render("~/content/kendo/2013.2.716/uniform-css")*@
    @Html.Action(MVC.Tenancy.Css())
    @RenderSection("styles", required: false)
    @*@Scripts.Render("~/bundles/modernizr")*@
    <script src="https://ucosmic.firebaseapp.com/bower_components/riot/riot.min.js"></script>
    <script src="https://ucosmic.firebaseapp.com/bower_components/firebase/firebase.js"></script>
    @*<script src="https://www.gstatic.com/firebasejs/3.0.0/firebase.js"></script>*@
        @Scripts.Render("~/bundles/layout3")
    @Html.MetaAcceptLanguage()
</head>
<body>
    <nav class="my">
        <div class="container">
            <div class="content group">
                <div class="left">
                    @*<div class="group">
                        <a href="http://www.ucosmic.org" target="_blank">Powered by UCosmic</a>
                        <a href="http://ucosmic.wordpress.com" target="_blank">Blog</a>
                        @Html.Partial(MVC.Shared.Views._UserVoiceLink, new UserVoiceLinkModel(Request, ViewData) { CssClass = "user-voice" })
                    </div>*@
                </div>
                <div class="right">
                    <div class="group">
                        @if (Request.IsAuthenticated)
                        {
                            var principal = User.Identity.Name;
                            var tenantDomain = "";
                            var indexOfAt = principal.IndexOf('@');
                            if (indexOfAt > 0)
                            {
                                tenantDomain = principal.Substring(indexOfAt);
                                principal = principal.Substring(0, indexOfAt);
                            }

                            var customProfileTitle = (tenancy != null && !string.IsNullOrWhiteSpace(tenancy.CustomProfileTitle))
                                ? tenancy.CustomProfileTitle : "My UCosmic Profile";

                            <a class="principal" href="@Url.Action(MVC.People.Me())"><span>@principal</span><span class="tenant-domain">@tenantDomain</span> - @customProfileTitle</a>

                            var userImpersonating = Session.UserImpersonating();
                            if (userImpersonating != null)
                            {
                                <a onclick="delete_service_worker_cache()"  href="@Url.Action(MVC.Identity.UndoSignOver())" title="Sign back on as @userImpersonating.Identity.Name">Sign back</a>
                            }
                            else
                            {
                                <a onclick="delete_service_worker_cache()" href="@Url.Action(MVC.Identity.SignOut(Request.RawUrl))">Sign out</a>
                            }
                        }
                        else
                        {
                            <a onclick="delete_service_worker_cache()" href="@Url.Action(MVC.Identity.SignIn(Request.RawUrl))">Sign in</a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <nav class="modules">
        <ul class="group">
            <li class="home">
                <a href="@Url.Action(MVC.Home.Index())">Home</a>
            </li>
            <li class="agreements">
                <a href="@Url.Action(hasStyleDomain ? MVC.Agreements.TenantIndex(styleDomain) : MVC.Agreements.Index())">Agreements</a>
            </li>
            <li class="employees @ViewBag.EmployeesModuleTab">
                @{
                    var employeesHref = Url.Action(hasStyleDomain ? MVC.Employees.TenantIndex(styleDomain) : MVC.Employees.Index());
                    var lastEmployeeLens = Session.LastEmployeeLens();
                    if (lastEmployeeLens != null && lastEmployeeLens.StartsWith(string.Format("/{0}/", styleDomain)))
                    {
                        employeesHref = lastEmployeeLens;
                    }
                }
                <a href="@employeesHref">Faculty & Staff</a>
            </li>
            <li class="summary">
                <a href="@Url.Action(MVC.Summary.Map())">Summary</a>
            </li>
            @*<li class="alumni">
                    <a href="@Url.Action(MVC.Home.Alumni())">Alumni</a>
                </li>
                <li class="reps">
                    <a href="@Url.Action(MVC.Home.Representatives())">Representatives</a>
                </li>
                <li class="travel">
                    <a href="@Url.Action(MVC.Home.Travel())">Travel</a>
                </li>
                <li class="corporate">
                    <a href="@Url.Action(MVC.Home.CorporateEngagement())">Corporate Engagement</a>
                </li>
                <li class="press">
                    <a href="@Url.Action(MVC.Home.GlobalPress())">Global Press</a>
                </li>*@
            @if (User.IsInAnyRole(RoleName.UserManagers, RoleName.EstablishmentAdministrator))
            {
                <li class="admin @ViewBag.AdminModuleTab">
                    <a href="@Url.Action(MVC.Admin.Index())">Admin</a>
                </li>
            }
        </ul>
    </nav>
    <header>
        <div class="container">
            <div class="content">
                <div class="flasher hide" data-bind="jqElement: '$element'">
                    <a data-bind="click: dismiss">
                        <div class="group">
                            <p>
                                <span class="content" data-bind="text: text"></span>
                                <span class="dismissal">Click to dismiss (<span data-bind="text: tickCount"></span>)</span>
                            </p>
                            <i class="on-right closer"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </header>
    @if (IsSectionDefined("bib"))
    {
        @RenderSection("bib")
    }
    else
    {
        @Html.Partial(MVC.Shared.Views._SampleStylingBib)
    }
    <div id="main" class="group">
        @RenderBody()
    </div>
    <footer>
        <div>
            <nav class="modules group">
                <ul class="group on-left">
                    <li class="home">
                        <a href="@Url.Action(MVC.Home.Index())">
                            Home
                        </a>
                    </li>
                    <li class="agreements">
                        <a href="@Url.Action(hasStyleDomain ? MVC.Agreements.TenantIndex(styleDomain) : MVC.Agreements.Index())">
                            Agreements
                        </a>
                    </li>
                    <li class="employees">
                        <a href="@employeesHref">
                            Faculty & Staff
                        </a>
                    </li>
                    <li class="employees">
                        <a href="/Summary/Map">
                            Summary
                        </a>
                    </li>
                    @*<li class="alumni">
                            <a href="@Url.Action(MVC.Home.Alumni())">
                                Alumni
                            </a>
                        </li>
                        <li class="students">
                            <a href="@Url.Action(MVC.Home.Students())">
                                Students
                            </a>
                        </li>
                        <li class="reps">
                            <a href="@Url.Action(MVC.Home.Representatives())">
                                Representatives
                            </a>
                        </li>
                        <li class="travel">
                            <a href="@Url.Action(MVC.Home.Travel())">
                                Travel
                            </a>
                        </li>
                        <li class="corporate">
                            <a href="@Url.Action(MVC.Home.CorporateEngagement())">
                                Corporate Engagement
                            </a>
                        </li>
                        <li class="press">
                            <a href="@Url.Action(MVC.Home.GlobalPress())">
                                Global Press
                            </a>
                        </li>*@
                    @if (User.IsInAnyRole(RoleName.UserManagers, RoleName.EstablishmentAdministrator))
                    {
                        <li class="admin">
                            <a href="@Url.Action(MVC.Admin.Index())">Admin</a>
                        </li>
                    }
                </ul>
                <div class="powered-by on-right">
                    <a href="http://www.github.com/ucosmic" target="_blank" title="Source code version @ViewBag.Version">Powered by UCosmic</a> | Copyright &copy; 2011-                    @DateTime.UtcNow.Year
                  
                    @if (User.Identity.Name == "")
                    {
                        <span>| </span>
                        <a href="#" onclick="clear_tenant_cookie()">Clear Tennant</a>
                    }
                </div>
            </nav>
        </div>
    </footer>
    <input id="scroll_top_tracker" type="hidden" />


    <script type="text/javascript">
        function delete_service_worker_cache() {
            function sendMessage(message) {
                // This wraps the message posting/response in a promise, which will
                // resolve if the response doesn't contain an error, and reject with
                // the error if it does. If you'd prefer, it's possible to call
                // controller.postMessage() and set up the onmessage handler
                // independently of a promise, but this is a convenient wrapper.
                return new Promise(function (resolve, reject) {
                    var messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = function (event) {
                        if (event.data.error) {
                            reject(event.data.error);
                        } else {
                            resolve(event.data);
                        }
                    };

                    // https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage(message, [messageChannel.port1]);
                    }
                });
            }
            sendMessage('delete cache');
        }
        function moduleNav(selector) {
            var current = document.querySelector('[data-current-module]').dataset.currentModule;
            var current_el = document.querySelector('nav.modules li.' + current);
            current_el ? current_el.classList.add('current') : null;

            document.querySelector('nav.modules').classList.remove('hide');
        }
        function bibNav(selector) {
            var current_bib_el = document.querySelector('[data-current-bib]')
            if (current_bib_el) {
                current = current_bib_el.dataset.currentBib;
                var current_el = document.querySelector('nav.bib li.' + current);
                current_el ? current_el.classList.add('current') : null;
                document.querySelector('nav.bib').classList.remove('hide');
            }
        }
        bibNav("body");
        moduleNav("body");
        //debugger;


        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
            .then(function() {

            })
            .catch(function () {

            });
            function sendMessage(message) {
                // This wraps the message posting/response in a promise, which will
                // resolve if the response doesn't contain an error, and reject with
                // the error if it does. If you'd prefer, it's possible to call
                // controller.postMessage() and set up the onmessage handler
                // independently of a promise, but this is a convenient wrapper.
                return new Promise(function (resolve, reject) {
                    var messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = function (event) {
                        if (event.data.error) {
                            reject(event.data.error);
                        } else {
                            resolve(event.data);
                        }
                    };

                    // https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage(message, [messageChannel.port1]);
                    }
                });
            }
            setTimeout(function () {
                //sendMessage('test');
            }, 5000)
        }

        function deleteAllCookies() {
            var cookies = document.cookie.split(";");

            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

        function clear_tenant_cookie(url, event) {
            delete_service_worker_cache();
            localStorage.clear();
            sessionStorage.clear();
            deleteAllCookies();
            //document.cookie = 'Tenancy=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            //setTimeout(function () {
                if (window.location.href.indexOf('?') > 1) {
                    window.location.href = window.location + '&timestamp=' + Date.now();//'&reload_me';
                } else {
                    window.location.href = window.location + '?timestamp=' + Date.now();//'?reload_me';
                }
            //}, 100)
                event ? event.preventDefault() : null;
        }
    </script>

    @RenderSection("scripts", required: false)

    <script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-56131112-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
